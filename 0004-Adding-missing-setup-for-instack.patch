From a758de119652839b37aaf70ff92c7e1b1a9591b3 Mon Sep 17 00:00:00 2001
From: Ladislav Smola <lsmola@redhat.com>
Date: Tue, 29 Apr 2014 17:27:11 +0200
Subject: [PATCH 3/3] Adding missing setup for instack

-adding setup of neutron and workaround for flavors

Change-Id: I59fc22b60938ad9f548cab2990ca9f1f45d8a1f7
---
 .../templates/overcloud/_detail_overview.html      | 29 ++++++++++++++++++++--
 1 file changed, 27 insertions(+), 2 deletions(-)

diff --git a/tuskar_ui/infrastructure/overcloud/templates/overcloud/_detail_overview.html b/tuskar_ui/infrastructure/overcloud/templates/overcloud/_detail_overview.html
index e87f5c6..990fa6e 100644
--- a/tuskar_ui/infrastructure/overcloud/templates/overcloud/_detail_overview.html
+++ b/tuskar_ui/infrastructure/overcloud/templates/overcloud/_detail_overview.html
@@ -118,11 +118,17 @@
   # You need to run the following commands from a Undercloud node where you have
   # direct access via SSH to your Overcloud control node ({{overcloud.keystone_ip}}).
 
-  # Usually stack user has access to Overcloud control node, so switch to stack user
-  su stack
+  # Run these commands as the user you used to install the undercloud, likely the stack
+  # user if you followed the recommendations from http://openstack.redhat.com/Deploying_RDO_using_Instack.
+  # The commands should also be run from the home directory of that user.
+
+  # Source your deploy-overcloudrc
+  # This file was created when you followed http://openstack.redhat.com/Deploying_an_RDO_Overcloud_with_Instack
+  source deploy-overcloudrc
 
   export OVERCLOUD_IP={{overcloud.keystone_ip}}
 
+  cat > tripleo-overcloud-passwords <<EOF
   export OVERCLOUD_ADMIN_TOKEN={{overcloud.attributes.AdminToken}}
   export OVERCLOUD_ADMIN_PASSWORD={{overcloud.attributes.AdminPassword}}
   export OVERCLOUD_CINDER_PASSWORD={{overcloud.attributes.CinderPassword}}
@@ -132,6 +138,18 @@
   export OVERCLOUD_NOVA_PASSWORD={{overcloud.attributes.NovaPassword}}
   export OVERCLOUD_SWIFT_PASSWORD={{overcloud.attributes.SwiftPassword}}
   export OVERCLOUD_SWIFT_HASH={{overcloud.attributes.SwiftHashSuffix}}
+  EOF
+
+  source tripleo-overcloud-passwords
+
+  JSONFILE=nodes.json
+  if [ ! -f $JSONFILE ]; then
+    echo '{}' > $JSONFILE
+  fi
+  OVERCLOUD_ENDPOINT="http://{{overcloud.keystone_ip}}:5000/v2.0"
+  NEW_JSON=$(jq '.overcloud.password="'{{overcloud.attributes.AdminPassword}}'" | .overcloud.endpoint="'${OVERCLOUD_ENDPOINT}'" | .overcloud.endpointhost="'{{overcloud.keystone_ip}}'"' $JSONFILE)
+  echo $NEW_JSON > $JSONFILE
+  export TE_DATAFILE=$JSONFILE
 
   source /etc/tripleo/overcloudrc
 
@@ -145,6 +163,13 @@
       --swift-password $OVERCLOUD_SWIFT_PASSWORD \
       --enable-horizon
   keystone role-create --name heat_stack_user
+
+  # Setup the neutron
+  tripleo setup-neutron "" "" $NETWORK_CIDR "" "" "" $FLOATING_IP_START $FLOATING_IP_END $FLOATING_IP_CIDR
+
+  # Workaround https://bugs.launchpad.net/diskimage-builder/+bug/1211165
+  nova flavor-delete m1.tiny
+  nova flavor-create m1.tiny 1 512 2 1
           </pre>
         </div>
       </li>
-- 
1.8.1.4

